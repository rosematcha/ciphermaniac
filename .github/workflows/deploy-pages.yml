name: Deploy Pages (build functions + register cron)

on:
  push:
    branches: [ main ]

jobs:
  deploy-pages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build Pages Functions
        run: npx wrangler pages functions build functions

      - name: Deploy Pages (includes updating triggers from wrangler.toml)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          PAGES_PROJECT_NAME: ciphermaniac
        run: |
          # Deploy the Pages site and publish the functions bundle.
          # The wrangler 'pages deploy' command will read triggers from wrangler.toml
          npx wrangler pages deploy public --project-name $PAGES_PROJECT_NAME --branch main

      - name: Post-deploy note
        run: echo "Deployed Pages. Check Cloudflare dashboard > Pages > Triggers to confirm the Cron Trigger is registered."
